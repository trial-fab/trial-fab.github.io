<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Class Length Tracker</title>
    <style>
      :root { --gap: 14px; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 840px; margin: 24px auto; padding: 0 12px; }
      h1 { margin: 0 0 8px; }
      .sub { color: #555; margin-bottom: 16px; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }

      /* Vertical form layout */
      form label { display: block; margin: 0 0 6px; font-weight: 600; }
      .field { margin-bottom: var(--gap); }
      input, button, select { font: inherit; }
      input[type="number"], input[type="time"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-sizing: border-box;
      }
      button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; }
      .actions { display: flex; align-items: center; gap: 12px; margin-top: 4px; flex-wrap: wrap; }
      #status { font-size: 0.95em; color: #444; }

      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
      th { background: #fafafa; }
      .muted { color: #777; }
      .inline { display: inline-flex; align-items: center; gap: 8px; }
      .pill { padding: 4px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 0.9em; }
      .right { text-align: right; }
      .hint { font-size: 0.9em; color: #666; }
      .danger { color: #b00020; }
      .success { color: #0a6; }

      /* Compact two-column utility for the estimate header */
      .row { display: grid; grid-template-columns: 1fr auto; gap: 12px; }
      @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <h1>Class Length Tracker</h1>
    <div class="sub">Add a deck entry and see the live ETA for the lecture.</div>

    <div class="card">
      <form id="entryForm" autocomplete="off">
        <div class="field">
          <label for="ppt_number">PowerPoint #</label>
          <input id="ppt_number" type="number" name="ppt_number" min="0" required>
        </div>
        <div class="field">
          <label for="slides">Slides</label>
          <input id="slides" type="number" name="slides" min="0" required>
        </div>
        <div class="field">
          <label for="start_time">Start time (HH:MM)</label>
          <input id="start_time" type="time" name="start_time" required>
        </div>
        <div class="field">
          <label for="end_time">End time (HH:MM)</label>
          <input id="end_time" type="time" name="end_time" required>
        </div>

        <!-- Stored for context on the sheet -->
        <input type="hidden" name="date_local" id="date_local">

        <div class="actions">
          <button type="submit">Add</button>
          <span id="status" class="muted"></span>
        </div>
      </form>
      <div class="hint">Times are interpreted for America/New_York.</div>
    </div>

    <div class="card">
      <h2>Live estimate</h2>
      <div class="row">
        <div>
          <div class="inline">
            <span class="pill">Average rate</span>
            <span id="avgRate" class="muted">—</span>
          </div>
          <div class="inline" style="margin-left:12px">
            <span class="pill">Total slides entered</span>
            <span id="totalSlides" class="muted">—</span>
          </div>
        </div>
        <div class="right">
          <div class="inline">
            <label class="muted">Remaining slides
              <input id="remainingSlides" type="number" min="0" value="30" style="width:120px; margin-left:8px;">
            </label>
            <button id="calcBtn" type="button" title="Calculate ETA">Calculate</button>
          </div>
        </div>
      </div>
      <div id="eta" style="margin-top:10px" class="muted">Enter some entries to compute the rate.</div>
    </div>

    <div class="card">
      <h2>Recent entries</h2>
      <table id="table"></table>
      <div class="hint" id="updatedAt"></div>
    </div>

    <script>
      // ===== CONFIGURE THIS =====
      const API = 'https://script.google.com/macros/s/AKfycbytlax3H4dtBA5WAyOU5uK86DrewPP2MkJFmwDG5ekgAMiUEc_2q9kjo0MRQE8ub7EG/exec'; // must end with /exec

      // === Time helpers ===
      function nowInNY() {
        return new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
      }

      function nyDateAt(timeHHMM) {
        const nyNow = nowInNY();
        const [hh, mm] = String(timeHHMM).split(':').map(Number);
        const y = nyNow.getFullYear();
        const m = nyNow.getMonth() + 1;
        const d = nyNow.getDate();
        const nyMillis = new Date(
          new Date(`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')} ${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`)
            .toLocaleString('en-US', { timeZone: 'America/New_York' })
        ).getTime();
        return new Date(nyMillis);
      }

      function minutesBetweenTimes(startHHMM, endHHMM) {
        const s = nyDateAt(startHHMM);
        const e = nyDateAt(endHHMM);
        let diff = (e - s) / 60000;
        if (diff < 0) diff += 24 * 60;
        return diff;
      }

      function setNYDateHidden() {
        const ny = nowInNY();
        const y = ny.getFullYear();
        const m = String(ny.getMonth() + 1).padStart(2, '0');
        const d = String(ny.getDate()).padStart(2, '0');
        document.getElementById('date_local').value = `${y}-${m}-${d}`;
      }
      setNYDateHidden();
      setInterval(setNYDateHidden, 60_000);

      // Display-only: normalize anything to "HH:MM"
      function formatHHMM(value) {
        if (!value && value !== 0) return '';
        // Already looks like "HH:MM"
        if (typeof value === 'string' && /^\d{1,2}:\d{2}$/.test(value)) return value;
        // Try parsing dates or numbers from Sheets
        const d = new Date(value);
        if (!isNaN(d)) {
          const hh = String(d.getHours()).padStart(2,'0');
          const mm = String(d.getMinutes()).padStart(2,'0');
          return `${hh}:${mm}`;
        }
        // Try extracting HH:MM from a long string
        const m = String(value).match(/(\d{1,2}:\d{2})/);
        return m ? m[1] : String(value);
      }

      // === Data IO ===
      async function fetchData() {
        const res = await fetch(API);
        const json = await res.json().catch(() => ({}));
        return json.data || [];
      }

      function computeStats(rows) {
        const rates = [];
        let totalSlides = 0;

        rows.forEach(r => {
          const slides = Number(r.slides);
          const st = formatHHMM(r.start_time);
          const et = formatHHMM(r.end_time);
          if (!slides || !st || !et) return;
          const mins = minutesBetweenTimes(st, et);
          if (mins > 0 && slides > 0) {
            rates.push(mins / slides);
            totalSlides += slides;
          }
        });

        const avgRateMinPerSlide = rates.length
          ? rates.reduce((a, b) => a + b, 0) / rates.length
          : null;

        return { avgRateMinPerSlide, totalSlides };
      }

      function renderTable(rows) {
        const table = document.getElementById('table');
        table.innerHTML = '';
        if (!rows.length) {
          table.innerHTML = '<tr><td class="muted">No data yet</td></tr>';
          return;
        }

        // Only these 4 columns, with time formatted as HH:MM
        const header = document.createElement('tr');
        ['ppt_number','slides','start_time','end_time'].forEach(h => {
          const th = document.createElement('th'); th.textContent = h; header.appendChild(th);
        });
        table.appendChild(header);

        rows.slice(-12).forEach(r => {
          const tr = document.createElement('tr');
          const cells = {
            ppt_number: r.ppt_number ?? '',
            slides: r.slides ?? '',
            start_time: formatHHMM(r.start_time),
            end_time: formatHHMM(r.end_time)
          };
          ['ppt_number','slides','start_time','end_time'].forEach(k => {
            const td = document.createElement('td'); td.textContent = cells[k]; tr.appendChild(td);
          });
          table.appendChild(tr);
        });

        document.getElementById('updatedAt').textContent =
          `Updated ${nowInNY().toLocaleString('en-US', { timeZone: 'America/New_York' })} (America/New_York)`;
      }

      function renderStats(rows) {
        const { avgRateMinPerSlide, totalSlides } = computeStats(rows);
        const avgRateEl = document.getElementById('avgRate');
        const totalSlidesEl = document.getElementById('totalSlides');
        const etaEl = document.getElementById('eta');

        if (avgRateMinPerSlide == null) {
          avgRateEl.textContent = '—';
          totalSlidesEl.textContent = String(totalSlides);
          etaEl.textContent = 'Enter some entries to compute the rate.';
          return;
        }

        avgRateEl.textContent = `${avgRateMinPerSlide.toFixed(2)} min/slide`;
        totalSlidesEl.textContent = String(totalSlides);

        const rem = Number(document.getElementById('remainingSlides').value || 0);
        const minsLeft = rem * avgRateMinPerSlide;
        if (rem > 0) {
          const eta = new Date(nowInNY().getTime() + minsLeft * 60000);
          const etaStr = eta.toLocaleString('en-US', { timeZone: 'America/New_York' });
          etaEl.textContent = `Estimated time left ${minsLeft.toFixed(1)} min. ETA ${etaStr}`;
        } else {
          etaEl.textContent = 'Set remaining slides to get ETA.';
        }
      }

      async function refresh() {
        try {
          const rows = await fetchData();
          renderTable(rows);
          renderStats(rows);
        } catch (e) {
          console.error(e);
          document.getElementById('eta').textContent = 'Could not load data.';
        }
      }

      document.getElementById('calcBtn').addEventListener('click', refresh);

      document.getElementById('entryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const payload = Object.fromEntries(fd.entries());

        const status = document.getElementById('status');
        status.textContent = 'Saving…';

        try {
          await fetch(API, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          status.textContent = 'Saved. Refreshing…';
          e.target.reset();
          setTimeout(refresh, 800);
          setTimeout(() => status.textContent = '', 1500);
        } catch (err) {
          status.textContent = 'Network error.';
          status.classList.add('danger');
        }
      });

      refresh();
      setInterval(refresh, 60_000);
    </script>
  </body>
</html>
